sap.ui.define(["./BaseController","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","../model/formatter","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,a,o,r,i,n){"use strict";return e.extend("batchuploads.controller.Worklist",{formatter:o,_oDialog:null,onInit:function(){var e;this._oModel=this.getOwnerComponent().getModel();this._aTableSearchState=[];var t=this.getOwnerComponent().getModel("transTypesData");var o=this.getOwnerComponent().getModel("uploadRangesData");e=new a({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableNoDataText:this.getResourceBundle().getText("tableNoDataText")});this.setModel(e,"worklistView");this.setModel(t,"transTypes");this.setModel(o,"uploadRangesList");var r=this;this.getView().addEventDelegate({onAfterShow:function(e){var t=r.byId("table");t.getBinding("items").refresh()}});this.getView().byId("companyCodeList").setFilterFunction(function(e,t){return t.getText().match(new RegExp(e,"i"))||t.getKey().match(new RegExp(e,"i"))})},onUpdateFinished:function(e){var t,a=e.getSource(),o=e.getParameter("total");if(o&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[o])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getModel("worklistView").setProperty("/worklistTableTitle",t)},onPress:function(e){this._showObject(e.getSource())},onNavBack:function(){history.go(-1)},handleLoadItems:function(e){e.getSource().getBinding("items").resume()},onCompanyCodeChange:function(e){var t=this.byId("table").getBinding("items"),a=e.getSource().getSelectedKey();var o=[];if(a.length>0)o.push(new i("glCompanyCode",n.EQ,a));t.filter(o)},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var a=e.getParameter("query");var o=[];var r=new i({path:"batchDescription",operator:n.Contains,value1:a,caseSensitive:false});o.push(r);var s=new i(o,false);if(a&&a.length>0){t=s}this._applySearch(t)}},onRefresh:function(){var e=this.byId("table");e.getBinding("items").refresh()},_showObject:function(e){this.getRouter().navTo("object",{objectId:e.getBindingContext().getPath().substring("/StagingUploads".length)});sap.ui.core.BusyIndicator.show()},_applySearch:function(e){var t=this.byId("table"),a=this.getModel("worklistView");t.getBinding("items").filter(e,"Application");if(e.length!==0){a.setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},onPressApprove:function(e){var a=e.getSource().getParent().getBindingContext().getProperty("ID");var o=e.getSource().getParent().getBindingContext().getProperty("batchDescription");var r=e.getSource().getParent().getBindingContext().getProperty("glCompanyCode");var i=e.getSource().getParent().getBindingContext().getProperty("currencyCode");var n=e.getSource().getParent().getBindingContext().getProperty("payrollDate");var s=e.getSource().getParent().getBindingContext().getProperty("effectivePeriod");var l=this.getView();var g=this;if(!g._oDialog){t.load({id:l.getId(),name:"batchuploads.fragments.Approve",controller:g}).then(function(e){g._oDialog=e;l.addDependent(e);l.byId("approvePageTitle").setText("Upload Batch "+a);l.byId("approveDesc").setText(o);l.byId("aprroveCurrency").setText(i);l.byId("approveCompanyCode").setText(r);l.byId("approvePayrollDate").setText(n);l.byId("approveEffectivePeriod").setText(s);e.open()})}else{g._oDialog.open()}},closeApprovalDialog:function(){if(this._oDialog){this._oDialog.close()}},onAfterClose:function(e){e.getSource().destroyBeginButton();e.getSource().destroyEndButton();e.getSource().destroyContent();e.getSource().destroy();this._oDialog=null},onUpload:function(){var e=this.getView();if(!this.byId("uploadDialog")){t.load({id:e.getId(),name:"batchuploads.fragments.Upload",controller:this}).then(function(t){e.addDependent(t);e.byId("uploadCompanyCode").setFilterFunction(function(e,t){return t.getText().match(new RegExp(e,"i"))||t.getKey().match(new RegExp(e,"i"))});e.byId("uploadCurrency").setFilterFunction(function(e,t){return t.getText().match(new RegExp(e,"i"))||t.getKey().match(new RegExp(e,"i"))});t.open()})}else{this.byId("uploadDialog").open()}},handleUploadComplete:function(e){var t=this.byId("uploadDialog");var a=e.getParameter("status");var o=JSON.parse(e.getParameter("responseRaw")).error.message;var i,n=this.byId("table").getBinding("items").aContexts[0];var s=this;if(a===200){this.onRefresh();i="BATCH "+s._newBatchId+" uploaded successfully!";r.success(i)}else{n.delete().then(function(){if(a===400)o=JSON.parse(o).join("\n");r.error(o)},function(e){console.log(e.message)})}t.setBusy(false);this.closeDialog()},submitUploads:function(){var e=this.byId("uploadDialog");e.setBusy(true);var t=this.getView().byId("uploadCompanyCode").getSelectedKey();var a=this.getView().byId("transTypeDlg").getSelectedItem().getKey();var o=this.getView().byId("uploadCurrency").getSelectedKey();var i=this.formatPayrollDate(this.getView().byId("payrollDateDlg").getValue());var n=this.formatDateString(this.getView().byId("glPeriodDlg").getValue());var s=this.formatDateString(this.getView().byId("effectivePeriodDlg").getValue());var l=this.getView().byId("batchDescDlg").getValue();var g="";var d=this.byId("table").getBinding("items").create({glCompanyCode:t,transactionType:a,currencyCode:o,payrollDate:i,glPeriod:n,effectivePeriod:s,batchDescription:l,remarks:g});var c=this.byId("fileUploader");var u=this;var h=this.getView().getModel().getHttpHeaders()["X-CSRF-Token"];var p=new sap.ui.unified.FileUploaderParameter;p.setName("x-csrf-token");p.setValue(h);d.created().then(function(){console.log(u._uploadFileName.name);u._newBatchId=d.getProperty("ID");var t='form-data; filename="'+u._uploadFileName.name+'"; batchID='+u._newBatchId;var a=new sap.ui.unified.FileUploaderParameter;a.setName("content-disposition");a.setValue(t);c.removeHeaderParameter("content-disposition");c.removeHeaderParameter("x-csrf-token");c.addHeaderParameter(a);c.addHeaderParameter(p);const o=location.href.substring(0,location.href.lastIndexOf("/"));c.setUploadUrl(`${o}/payroll/PayrollUploadFile/content`);c.checkFileReadable().then(function(){c.upload()}).catch(function(t){r.error("The file cannot be read.");e.setBusy(false)})},function(e){r.error("The file cannot be uploaded.");c.clear()})},convertPayrollDate:function(e){var t=e.getParameter("value");var a=new Date(t);var o=a.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}).replace(/ /g,"-");this.byId("payrollDateDlg").setValue(o)},formatPayrollDate:function(e){var t=e.split("-");var a=new Date(Date.parse(t[1]+" 1, 2012")).getMonth()+1;return a.toString().length===2?t[2]+"-"+a+"-"+t[0]:t[2]+"-"+"0"+a+"-"+t[0]},formatDateString:function(e){var t=new Date(e);var a=t.getMonth()+1;var o=t.getFullYear();return a.toString().length===2?o.toString()+a.toString():o.toString()+"0"+a.toString()},onChangeFUP:function(e){this._uploadFileName=e.getParameter("files")&&e.getParameter("files")[0]},old_onChangeFUP:function(e){var t=e.getParameter("files")&&e.getParameter("files")[0];this._newID=parseInt(this._nHeaderCnt)+1;var a=this.getOwnerComponent().getModel("uploadJsonData");var o=a.getProperty("/");if(t&&window.FileReader){var r=new FileReader;var i=this;r.onload=function(e){var t=e.target.result;var r=t.split("\n");i._dataset=[];for(let e=1;e<r.length;e++){var n=r[e].split("\t");var s={CREATEDAT:"",CREATEDBY:"",MODIFIEDAT:"",MODIFIEDBY:"",PARENT_ID:i._newID,STATUS:"STAGED",STATUSMESSAGE:"",DELETED:"",FMNO:n[0],PAYROLLCODE:n[1],PAYROLLCODESEQUENCE:"",NAME:"",AMOUNT:n[4],PAYMENTNUMBER:"",PAYMENTID:n[6],PAYMENTFORM:"",USERFIELD1:"",USERFIELD2:"",REMARKS:"",LOANADVANCEREFERENCENUMBER:n[11],PROJECTCODE:n[12],PROJECTTASK:"",GLACCOUNT:"",GLCOSTCENTER:""};o.push(s);a.setProperty("/",o)}};r.readAsText(t)}},old_submitUploads:function(){var e=this.getView().byId("companyCode").getValue();var t=this.getView().byId("transType").getSelectedItem().getText();var a=this.getView().byId("payrollDate").getValue();var o=this.getView().byId("glPeriod").getValue();var r=this.getView().byId("effectivePeriod").getValue();var i=this.getView().byId("batchDesc").getValue();var n={batchDescription:i,BATCHNUMBER:this._newID,effectiveDate:r,companyCode:e,glDate:o,ID:this._newID.toString(),payrollDate:a,batchStatus:"STAGED"};var s=this.getView().getModel();var l=s.getProperty("/");l.push(n);s.setProperty("/",l);if(this.byId("uploadDialog")){this.byId("uploadDialog").close();this.byId("uploadDialog").destroy()}},closeDialog:function(){if(this.byId("uploadDialog")){this.byId("uploadDialog").close();this.byId("uploadDialog").destroy()}},handleSettingsPress:function(e){var a=e.getSource(),o=this.getView();if(!this._pPopover){this._pPopover=t.load({id:o.getId(),name:"batchuploads.fragments.Settings",controller:this}).then(function(e){o.addDependent(e);return e})}this._pPopover.then(function(e){e.openBy(a)})}})});